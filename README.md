# Видеомониторинг и настройки (Gradio)

## Описание

Веб-приложение для просмотра RTSP-потоков и редактирования всех параметров файла `config.yaml` через удобный интерфейс. Все изменения можно сохранить локально, отправить на рокчип через SCP или через API. Интерфейс полностью на русском языке.

## Запуск через Docker Compose

1. Убедитесь, что файл `opi5test/core/config.yaml` существует и содержит нужные параметры.
2. Перейдите в папку `web`:
   ```bash
   cd web
   ```
3. Соберите и запустите контейнер:
   ```bash
   docker-compose up --build
   ```
4. Откройте браузер и перейдите по адресу: [http://localhost:7860](http://localhost:7860)

5. Для остановки контейнера перейдите в папку `web` и выполните следующую команду:

   ```bash
   docker-compose down
   ```

## Запуск в виртуальном окружении

1. Создайте виртуальное окружение:
   ```bash
   python3 -m venv web_venv
   source web_venv/bin/activate
   ```

2. Установите зависимости:
   ```bash
   pip install gradio requests websocket-client opencv-python numpy
   ```

3. Запустите приложение:
   ```bash
   python3 app.py
   ```

## Функционал

### Видеомониторинг
- Окно для просмотра RTSP-потока (требуется прокси для реального видео)
- Поле для ввода RTSP-URL
- Отображение UDP тревог в реальном времени

### Управление конфигурацией
- Все параметры из `config.yaml` доступны для редактирования
- Кнопка **"Сохранить"** — сохраняет изменения в `config.yaml` и отправляет на рокчип через SCP
- Кнопка **"Отправить через API"** — сохраняет локально и отправляет на рокчип через API
- Кнопка **"Сбросить"** — возвращает значения из файла

### Логи тревог
- Получение списка файлов логов с рокчипа
- Просмотр содержимого логов
- Автоматическое обновление списка

## Параметры нейронной сети

### Детекция нарушений
- **cigarette** - детекция курения
  - `duration`: длительность нарушения в секундах (0.1)
  - `threshold`: порог уверенности детектора (0.8)

- **closed_eyes** - детекция закрытых глаз
  - `duration`: длительность нарушения в секундах (1.0)
  - `threshold`: порог уверенности детектора (0.8)

- **closed_eyes_duration** - отслеживание времени закрытых глаз
  - `tracking_window`: окно отслеживания в секундах (60)
  - `threshold`: максимальное время закрытых глаз в секундах (10)

- **head_pose** - детекция поворота головы
  - `duration`: длительность нарушения в секундах (1.8)
  - `pitch`: угол наклона головы в радианах (0.5)
  - `yaw`: угол поворота головы в радианах (1.5)

- **no_belt** - детекция отсутствия ремня безопасности
  - `duration`: длительность нарушения в секундах (1.5)
  - `threshold`: порог уверенности детектора (0.8)

- **no_driver** - детекция отсутствия водителя
  - `duration`: длительность нарушения в секундах (0.5)
  - `threshold`: порог уверенности детектора (0.8)

- **no_face** - детекция отсутствия лица
  - `duration`: длительность нарушения в секундах (0.5)
  - `threshold`: порог уверенности детектора (0.8)

- **phone** - детекция использования телефона
  - `duration`: длительность нарушения в секундах (0.5)
  - `threshold`: порог уверенности детектора (0.8)

- **yawn** - детекция зевоты
  - `duration`: длительность нарушения в секундах (0.5)
  - `threshold`: порог уверенности детектора (0.3)

## API интеграция

Приложение поддерживает отправку конфигурации на рокчип через API:

- **Endpoint**: `PUT /config`
- **Протокол**: HTTP
- **Формат**: JSON
- **Автоматическая отправка**: при нажатии кнопки "Отправить через API"

### Настройка API
В секции `rockchip` конфига:
- `api_port`: порт API сервиса на рокчипе (по умолчанию 8000)

## Важно

В файле `config.yaml` параметр `alarm_server_ip` должен быть установлен в IP-адрес машины, где запущен Gradio-интерфейс. Если приложение запускается в Docker, используйте внешний IP хоста. Тревоги из ядра должны отправляться на этот адрес и порт, указанные в `alarm_server_ip` и `alarm_server_port`.

---

**Внимание:** Для реального отображения RTSP-потоков в браузере требуется проксирование потока в HLS/WebRTC. В текущей версии реализована заглушка для визуализации URL. 
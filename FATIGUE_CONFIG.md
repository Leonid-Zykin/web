# Настройка системы определения усталости водителя

## Введение

Система определения усталости (fatigue) анализирует поведение водителя в реальном времени и выявляет признаки утомления по четырём независимым компонентам:
- **Длинные моргания** — частые продолжительные закрытия глаз
- **Тренд межморганий** — учащение морганий (уменьшение интервалов между морганиями)
- **Зевки** — длительные открытия рта
- **«Клевки» головой** — кивки головой вниз с последующим возвратом

Каждый компонент работает независимо, но может быть объединён в **композитную логику**, которая суммирует признаки усталости от всех активных компонентов.

---

## Где находятся настройки

### В веб-интерфейсе
1. Откройте веб-интерфейс по адресу [http://localhost:7860](http://localhost:7860)
2. Прокрутите страницу до раздела **«Настройки усталости (fatigue)»**
3. Здесь вы увидите все параметры, разбитые по группам

### В файле конфигурации
Настройки также доступны в файле `opi5test/core/config.yaml` в разделе `fatigue`.

---

## Описание полей и параметров

### Базовые настройки

#### **Включить усталость** (`fatigue.enable`)
- **Тип:** Чекбокс (вкл/выкл)
- **Назначение:** Главный выключатель всей системы определения усталости
- **Значение по умолчанию:** `false` (выключено)
- **Что делает:**
  - `true` — система усталости активна, отслеживаются все включённые компоненты
  - `false` — система усталости полностью отключена, никакие события не регистрируются

#### **Окно, секунд** (`fatigue.window_seconds`)
- **Тип:** Число (целое)
- **Назначение:** Размер временного окна для подсчёта событий усталости
- **Значение по умолчанию:** `60` секунд
- **Что делает:** Система хранит события только за последние N секунд. Например, при значении 60 учитываются только моргания, зевки и кивки за последнюю минуту. Старые события автоматически удаляются.
- **Рекомендации:**
  - 60–120 секунд для дальних рейсов
  - 30–60 секунд для городских поездок

---

### Композитная логика

#### **Включить композитную сумму** (`fatigue.composite.enable`)
- **Тип:** Чекбокс (вкл/выкл)
- **Назначение:** Включает композитную (суммарную) оценку усталости
- **Значение по умолчанию:** `false`
- **Что делает:**
  - `true` — система суммирует количество событий от всех **включённых** компонентов (длинные моргания + зевки + кивки + тренд)
  - `false` — каждый компонент работает независимо, тревога поднимается, если хотя бы один компонент достиг своего порога

#### **Целевая сумма событий** (`fatigue.composite.target_sum`)
- **Тип:** Число (целое)
- **Назначение:** Порог суммы событий для поднятия тревоги при композитной логике
- **Значение по умолчанию:** `3`
- **Что делает:** Если композитная логика включена и сумма событий от всех компонентов ≥ этого значения, поднимается тревога `fatigue`.
- **Пример:** 
  - Длинные моргания: 1 событие
  - Зевки: 1 событие
  - Кивки: 2 события
  - **Сумма = 4** → тревога поднимается (если `target_sum = 3`)

---

### Длинные моргания

#### **Включить длинные моргания** (`fatigue.long_blinks.enable`)
- **Тип:** Чекбокс (вкл/выкл)
- **Назначение:** Включает отслеживание длинных морганий
- **Значение по умолчанию:** `false`
- **Что делает:**
  - `true` — система фиксирует длинные моргания (закрытия глаз определённой длительности)
  - `false` — длинные моргания не отслеживаются

#### **EAR порог** (`fatigue.long_blinks.ear_threshold`)
- **Тип:** Число с плавающей точкой (0.0–1.0) или пусто
- **Назначение:** Порог EAR (Eye Aspect Ratio) для определения закрытых глаз
- **Значение по умолчанию:** Пусто (используется `closed_eyes.threshold` из основной конфигурации)
- **Что делает:** Если EAR < этого порога, глаза считаются закрытыми. Типичное значение: 0.2–0.3.
- **Рекомендации:**
  - Оставьте пустым для использования общего порога закрытых глаз
  - Если нужен отдельный порог для усталости, укажите значение (например, 0.25)

#### **Мин. длительность, c** (`fatigue.long_blinks.min_duration_s`)
- **Тип:** Число с плавающей точкой
- **Назначение:** Минимальная длительность закрытия глаз для регистрации как «длинное моргание»
- **Значение по умолчанию:** `0.1` секунды
- **Что делает:** Моргания короче этого значения игнорируются (обычные быстрые моргания).

#### **Макс. длительность, c** (`fatigue.long_blinks.max_duration_s`)
- **Тип:** Число с плавающей точкой
- **Назначение:** Максимальная длительность закрытия глаз для регистрации как «длинное моргание»
- **Значение по умолчанию:** `0.4` секунды
- **Что делает:** Моргания дольше этого значения не учитываются (вероятно, это уже тревога «закрытые глаза»).

#### **Мин. число событий** (`fatigue.long_blinks.min_count`)
- **Тип:** Число (целое)
- **Назначение:** Минимальное количество длинных морганий в окне для поднятия тревоги
- **Значение по умолчанию:** `3`
- **Что делает:** Если за окно времени зафиксировано ≥ этого количества длинных морганий, поднимается тревога (если композитная логика выключена) или увеличивается сумма (если включена).

---

### Тренд межморганий

#### **Включить тренд межморганий** (`fatigue.interblink_trend.enable`)
- **Тип:** Чекбокс (вкл/выкл)
- **Назначение:** Включает отслеживание учащения морганий
- **Значение по умолчанию:** `false`
- **Что делает:**
  - `true` — система отслеживает интервалы между морганиями и фиксирует их уменьшение (учащение)
  - `false` — тренд не отслеживается

#### **EAR порог** (`fatigue.interblink_trend.ear_threshold`)
- **Тип:** Число с плавающей точкой или пусто
- **Назначение:** Порог EAR для определения моргания при расчёте интервалов
- **Значение по умолчанию:** Пусто (используется `closed_eyes.threshold`)
- **Что делает:** Аналогично порогу в длинных морганиях, но используется для фиксации моментов моргания для расчёта интервалов.

#### **Мин. интервалов (>=5)** (`fatigue.interblink_trend.min_intervals`)
- **Тип:** Число (целое, ≥5)
- **Назначение:** Минимальное количество интервалов между морганиями для начала расчёта тренда
- **Значение по умолчанию:** `5`
- **Что делает:** Пока не накоплено хотя бы это количество интервалов, тренд не рассчитывается.

#### **Окно среднего (штук)** (`fatigue.interblink_trend.avg_span`)
- **Тип:** Число (целое)
- **Назначение:** Количество последних интервалов для расчёта скользящего среднего
- **Значение по умолчанию:** `5`
- **Что делает:** Система берёт последние N интервалов и вычисляет их среднее значение.

#### **Падение среднего, мс** (`fatigue.interblink_trend.decrease_ms`)
- **Тип:** Число (целое, миллисекунды)
- **Назначение:** Порог уменьшения среднего интервала для фиксации события тренда
- **Значение по умолчанию:** `50` мс
- **Что делает:** Если новое среднее меньше предыдущего на это значение (в секундах: 50 мс = 0.05 с), фиксируется событие «учащение морганий».

#### **Мин. событий тренда** (`fatigue.interblink_trend.min_trend_events`)
- **Тип:** Число (целое)
- **Назначение:** Минимальное количество зафиксированных событий тренда для поднятия тревоги
- **Значение по умолчанию:** `3`
- **Что делает:** Если за окно времени зафиксировано ≥ этого количества событий учащения морганий, поднимается тревога.

---

### Зевки

#### **Включить зевки** (`fatigue.yawn.enable`)
- **Тип:** Чекбокс (вкл/выкл)
- **Назначение:** Включает отслеживание зевков
- **Значение по умолчанию:** `false`
- **Что делает:**
  - `true` — система фиксирует длинные открытия рта
  - `false` — зевки не отслеживаются

#### **MAR порог** (`fatigue.yawn.mar_threshold`)
- **Тип:** Число с плавающей точкой или пусто
- **Назначение:** Порог MAR (Mouth Aspect Ratio) для определения открытого рта
- **Значение по умолчанию:** Пусто (используется `yawn.threshold` из основной конфигурации)
- **Что делает:** Если MAR > этого порога, рот считается открытым. Типичное значение: 0.5–0.7.

#### **Мин. длительность, c** (`fatigue.yawn.min_duration_s`)
- **Тип:** Число с плавающей точкой
- **Назначение:** Минимальная длительность открытого рта для регистрации как «зевок»
- **Значение по умолчанию:** `0.4` секунды
- **Что делает:** Открытия рта короче этого значения игнорируются.

#### **Мин. число событий** (`fatigue.yawn.min_count`)
- **Тип:** Число (целое)
- **Назначение:** Минимальное количество зевков в окне для поднятия тревоги
- **Значение по умолчанию:** `2`
- **Что делает:** Если за окно времени зафиксировано ≥ этого количества зевков, поднимается тревога.

---

### «Клевки» головой

#### **Включить клевки головой** (`fatigue.head_nod.enable`)
- **Тип:** Чекбокс (вкл/выкл)
- **Назначение:** Включает отслеживание кивков головой вниз
- **Значение по умолчанию:** `false`
- **Что делает:**
  - `true` — система фиксирует циклы «голова вниз → голова вверх»
  - `false` — кивки не отслеживаются

#### **Порог вниз, °** (`fatigue.head_nod.pitch_down_delta_deg`)
- **Тип:** Число с плавающей точкой
- **Назначение:** Угол наклона головы вниз (в градусах) относительно нейтральной позиции для фиксации «голова вниз»
- **Значение по умолчанию:** `10.0` градусов
- **Что делает:** Если pitch (наклон) ≥ этого значения, голова считается наклонённой вниз.

#### **Мин. удержание вниз, c** (`fatigue.head_nod.min_down_duration_s`)
- **Тип:** Число с плавающей точкой
- **Назначение:** Минимальная длительность удержания головы в позиции «вниз»
- **Значение по умолчанию:** `0.3` секунды
- **Что делает:** Голова должна быть наклонена вниз хотя бы это время, чтобы при возврате вверх зафиксировался кивок.

#### **Гистерезис, °** (`fatigue.head_nod.hysteresis_deg`)
- **Тип:** Число с плавающей точкой
- **Назначение:** Гистерезис для определения возврата головы вверх
- **Значение по умолчанию:** `3.0` градуса
- **Что делает:** Для фиксации возврата «вверх» pitch должен опуститься ниже `(pitch_down_delta_deg - hysteresis_deg)`. Это предотвращает ложные срабатывания от небольших колебаний.

#### **Мин. число событий** (`fatigue.head_nod.min_count`)
- **Тип:** Число (целое)
- **Назначение:** Минимальное количество кивков в окне для поднятия тревоги
- **Значение по умолчанию:** `2`
- **Что делает:** Если за окно времени зафиксировано ≥ этого количества кивков, поднимается тревога.

---

## Пошаговая инструкция по настройке

### Шаг 1: Подготовка

1. **Убедитесь, что система работает:**
   - Запустите веб-интерфейс (`docker-compose -f docker-compose.video.yml up --build -d` в папке `web`)
   - Откройте браузер по адресу [http://localhost:7860](http://localhost:7860)
   - Убедитесь, что видеопоток отображается и основные тревоги работают

2. **Проверьте базовые тревоги:**
   - Убедитесь, что `closed_eyes` и `yawn` настроены и работают корректно
   - Система усталости использует те же пороги EAR/MAR, если вы не укажете отдельные значения

### Шаг 2: Включение системы усталости

1. Прокрутите страницу веб-интерфейса до раздела **«Настройки усталости (fatigue)»**
2. Поставьте галочку **«Включить усталость»** (`fatigue.enable = true`)
3. Установите **«Окно, секунд»** в значение `60` (для начала)
4. Нажмите **«💾 Сохранить усталость»**

### Шаг 3: Выбор стратегии детекции

Решите, какую логику вы хотите использовать:

#### Вариант A: Независимые компоненты (рекомендуется для начала)
- Оставьте **«Включить композитную сумму»** **выключенной**
- Включите 1–2 компонента, которые вам важнее всего (например, длинные моргания и зевки)
- Настройте пороги для каждого компонента отдельно
- Тревога поднимется, если **хотя бы один** компонент достигнет своего `min_count`

#### Вариант B: Композитная оценка (для комплексной детекции)
- Включите **«Включить композитную сумму»**
- Установите **«Целевая сумма событий»** = `3` (или больше)
- Включите несколько компонентов (длинные моргания, зевки, кивки)
- Тревога поднимется, когда **суммарное количество событий** от всех компонентов достигнет порога

### Шаг 4: Настройка длинных морганий

1. Включите **«Включить длинные моргания»**
2. Оставьте **«EAR порог»** пустым (будет использоваться `closed_eyes.threshold`)
3. Установите параметры:
   - **Мин. длительность:** `0.15` с (фильтрует обычные быстрые моргания)
   - **Макс. длительность:** `0.4` с (фильтрует «закрытые глаза»)
   - **Мин. число событий:** `3` (тревога при 3+ длинных морганиях в минуту)
4. Нажмите **«💾 Сохранить усталость»**

### Шаг 5: Настройка зевков

1. Включите **«Включить зевки»**
2. Оставьте **«MAR порог»** пустым (будет использоваться `yawn.threshold`)
3. Установите параметры:
   - **Мин. длительность:** `0.4` с
   - **Мин. число событий:** `2` (тревога при 2+ зевках в минуту)
4. Нажмите **«💾 Сохранить усталость»**

### Шаг 6: (Опционально) Настройка тренда межморганий

1. Включите **«Включить тренд межморганий»**
2. Оставьте **«EAR порог»** пустым
3. Установите параметры:
   - **Мин. интервалов:** `5`
   - **Окно среднего:** `5`
   - **Падение среднего:** `50` мс
   - **Мин. событий тренда:** `3`
4. Нажмите **«💾 Сохранить усталость»**

### Шаг 7: (Опционально) Настройка кивков головой

1. Включите **«Включить клевки головой»**
2. Установите параметры:
   - **Порог вниз:** `10.0`° (уменьшите, если водитель часто наклоняет голову; увеличьте при ложных срабатываниях)
   - **Мин. удержание вниз:** `0.3` с
   - **Гистерезис:** `3.0`°
   - **Мин. число событий:** `2`
3. Нажмите **«💾 Сохранить усталость»**

### Шаг 8: Тестирование и калибровка

1. **Наблюдайте за работой системы:**
   - В окне **«RAW UDP тревоги»** будут появляться события усталости
   - В данных телеметрии (если настроены) появятся поля:
     - `long_blinks_count` — текущее количество длинных морганий в окне
     - `interblink_trend_count` — количество событий тренда
     - `yawn_count` — количество зевков
     - `head_nod_count` — количество кивков
     - `fatigue_sum` — суммарное количество (если композитная логика включена)

2. **Корректируйте пороги:**
   - **Если тревоги не появляются:**
     - Уменьшите `min_count` для компонентов
     - Уменьшите `min_duration_s` для морганий и зевков
     - Уменьшите `pitch_down_delta_deg` для кивков
   - **Если слишком много ложных срабатываний:**
     - Увеличьте `min_count`
     - Увеличьте `min_duration_s`
     - Увеличьте `pitch_down_delta_deg`
     - Увеличьте `window_seconds` (например, до 90–120 секунд)

3. **Проверьте на реальных данных:**
   - Запишите видео с реальным водителем в состоянии усталости (или имитацией)
   - Проверьте, что система корректно детектирует признаки
   - Доработайте пороги по результатам

### Шаг 9: Применение настроек на OPi

1. После сохранения настроек в веб-интерфейсе они автоматически отправляются на OPi через API
2. Убедитесь, что в логах OPi (`docker logs cv_core`) появляются сообщения о детекции усталости:
   ```
   [ALARM] fatigue raised: counts={'long_blinks': 3, 'yawn': 2, ...}
   [RESET] fatigue cleared
   ```

### Шаг 10: Мониторинг и доработка

1. **Регулярно проверяйте логи тревог:**
   - Анализируйте, в каких ситуациях срабатывают тревоги
   - Корректируйте пороги для минимизации ложных срабатываний

2. **Используйте композитную логику для баланса:**
   - Если одиночные компоненты дают много ложных тревог, переключитесь на композитную сумму
   - Например, `target_sum = 5` при включённых 3–4 компонентах даст более надёжную детекцию

---

## Рекомендованные профили настроек

### Профиль 1: Консервативный (мало ложных тревог)
```yaml
fatigue:
  enable: true
  window_seconds: 90
  composite:
    enable: true
    target_sum: 5
  long_blinks:
    enable: true
    min_duration_s: 0.2
    max_duration_s: 0.5
    min_count: 4
  yawn:
    enable: true
    min_duration_s: 0.5
    min_count: 3
```

### Профиль 2: Сбалансированный
```yaml
fatigue:
  enable: true
  window_seconds: 60
  composite:
    enable: true
    target_sum: 3
  long_blinks:
    enable: true
    min_duration_s: 0.15
    max_duration_s: 0.4
    min_count: 3
  yawn:
    enable: true
    min_duration_s: 0.4
    min_count: 2
  head_nod:
    enable: true
    pitch_down_delta_deg: 10.0
    min_count: 2
```

### Профиль 3: Чувствительный (раннее обнаружение)
```yaml
fatigue:
  enable: true
  window_seconds: 45
  composite:
    enable: false
  long_blinks:
    enable: true
    min_duration_s: 0.1
    max_duration_s: 0.4
    min_count: 2
  yawn:
    enable: true
    min_duration_s: 0.3
    min_count: 1
```

---

## Диагностика проблем

### Тревога не появляется
1. Убедитесь, что `fatigue.enable = true`
2. Проверьте, что хотя бы один компонент включён
3. Убедитесь, что пороги не слишком высокие
4. Проверьте логи OPi на наличие ошибок
5. Убедитесь, что базовые тревоги (`closed_eyes`, `yawn`) работают

### Слишком много ложных срабатываний
1. Увеличьте `min_count` для компонентов
2. Увеличьте `window_seconds`
3. Включите композитную логику с высоким `target_sum`
4. Увеличьте пороги длительности (`min_duration_s`)

### Компонент не работает
1. Убедитесь, что компонент включён (`enable = true`)
2. Проверьте, что EAR/MAR пороги корректны (или оставьте пустыми для fallback)
3. Убедитесь, что в данных присутствуют поля `EAR`, `MAR`, `pitch`

---

## Заключение

Система определения усталости — мощный инструмент для повышения безопасности. Правильная настройка требует итеративного подхода: начните с консервативных порогов, тестируйте на реальных данных и постепенно корректируйте параметры для достижения оптимального баланса между чувствительностью и надёжностью.

Для получения дополнительной помощи обратитесь к документации API или свяжитесь с разработчиками.

